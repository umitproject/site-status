{% load media %}
{% load i18n %}
{% load status_tags %}
{% load user_tags %}
<!DOCTYPE HTML>
<html>
<head>
    <title></title>
    {% include_media 'main.js' %}
    {% include_media 'bootstrap.css' %}
    {% include_media 'jquery-ui.css' %}
    <style>
        body, section {
            padding-top: 40px;
        }
        .error {
            font-weight: 700;
            color: #B94A48;
        }
        .input-error {
            color:#B94A48;
            border-color: #B94A48;
        }
        textarea {
            height: 50px;
        }
    </style>
</head>
<body data-spy="scroll" data-target=".navbar-fixed-top">
    <div id="main-container" class="container">
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <ul class="nav pull-left">
                        <li>
                            <a href="#profile"><i class="icon-white icon-user"></i> My Profile</a>
                        </li>
                        <li>
                            <a href="#site_configs_monitor"><i class="icon-white icon-list-alt"></i> Site Configs</a>
                        </li>
                        <li>
                            <a href="#monitors"><i class="icon-white icon-eye-open"></i> Monitors</a>
                        </li>
                        <li>
                        <a href="#status-site-domains"><i class="icon-white icon-globe"></i> Site Domains</a>
                        </li>
                    </ul>
                    <ul class="nav pull-right">
                        <li>
                        <p class="navbar-text">
                            <i class="icon-white icon-user"></i> {% get_full_name user %}
                        </p>
                        </li>
                        <li>
                            <a href="{% url auth_logout %}">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <section id="profile">
            <div class="page-header">
                <h1>My Profile</h1>
            </div>
                <form method='post' action='/backend/update_profile'>{% csrf_token %}
                    <table>
                        {{  profile_form.as_table }}
                    </table>
                    <button class="btn btn-primary" type="submit" name="Submit" value="update_profile" data-complete-text="Saved!">Save</button>
                </form>
        </section>
        <section id="site_configs_monitor">
            <div class="page-header">
                <h1>My Site Configs</h1>
            </div>
            <ul class="nav nav-tabs" data-tabs="tabs" id="site-configs">
                <li class="active">
                    <a href="#add-site-config" data-toggle="tab"><i class="icon-plus"></i> Add</a>
                </li>
                {% for site_config_form in site_config_forms %}
                    <li data-form-id="{{ site_config_form.instance.pk }}">
                        <a href="#site-config-{{  site_config_form.instance.pk }}" data-toggle="tab">{{ site_config_form.initial.site_name }}</a>
                    </li>
                {% endfor %}
            </ul>

            <div class="tab-content" id="site-config-forms">
                <div class="tab-pane active" id="add-site-config">
                    <h2>Add a new Site Config</h2>
                    <form method="post" action='/backend/add_site_config'>{% csrf_token %}
                        <table>
                            {{ site_config_form_template.as_table }}
                        </table>
                        <input type="hidden" name="site_config_action" value="add"/>
                        <button class="btn btn-primary site-config-add" type="submit" name="Submit" value="add_site_config" data-complete-text="Saved!">Save</button>
                    </form>
                </div>
                {% for site_config_form in site_config_forms %}
                    {% include 'backend/site_config_form.html' %}
                {% endfor %}
            </div>
        </section>

        <section id="monitors">
            <div class="page-header">
                <h1>My Monitors</h1>
            </div>
            <ul class="nav nav-tabs" data-tabs="tabs" id="modules">
                <li class="active">
                    <a href="#add-module" data-toggle="tab"><i class="icon-plus"></i> Add</a>
                </li>
                {% for module_form in module_forms %}
                    <li data-form-id="{{ module_form.instance.pk }}">
                        <a href="#module-{{  module_form.instance.pk }}" data-toggle="tab">{{ module_form.initial.name }}</a>
                    </li>
                {% endfor %}
            </ul>

            <div class="tab-content" id="module-forms">
                <div class="tab-pane active" id="add-module">
                    <h2>Add a new Module</h2>
                    <form method="post" action='/backend/add_module'>{% csrf_token %}
                        <table>
                            {{ module_form_template.as_table }}
                        </table>
                        <input type="hidden" name="module_action" value="add"/>
                        <button class="btn btn-primary" type="submit" name="Submit" value="add_module" data-complete-text="Saved!">Save</button>
                    </form>
                </div>
                {% for module_form in module_forms %}
                    {% include 'backend/module_form.html' %}
                {% endfor %}
            </div>
        </section>
        <section id="status-site-domains">
            <div class="page-header">
                <h1>Status Site Domains</h1>
            </div>
            <ul class="nav nav-tabs" data-tabs="tabs" id="site-domains">
                <li class="active">
                    <a href="#add-site-domain" data-toggle="tab"><i class="icon-plus"></i> Add</a>
                </li>
                {% for site_domain_form in site_domain_forms %}
                    <li data-form-id="{{ site_domain_form.instance.pk }}">
                        <a href="#site-domain-{{  site_domain_form.instance.pk }}" data-toggle="tab">{{ site_domain_form.initial.status_url }}</a>
                    </li>
                {% endfor %}
            </ul>

            <div class="tab-content" id="site-domain-forms">
                <div class="tab-pane active" id="add-site-domain">
                    <h2>Add a new Site Domain</h2>
                    <form method="post" action='/backend/add_site_domain'>{% csrf_token %}
                        <table>
                            {{ site_domain_form_template.as_table }}
                        </table>
                        <input type="hidden" name="site_domain_action" value="add"/>
                        <button class="btn btn-primary" type="submit" name="Submit" value="add_site_domain" data-complete-text="Saved!">Save</button>
                    </form>
                </div>
                {% for site_domain_form in site_domain_forms %}
                    {%  include 'backend/site_domain_form.html' %}
                {% endfor %}
            </div>
        </section>
        <div style="height:1000px;"></div>
    </div>
    {% include_media 'bootstrap.js' %}
    <script type="text/template" id="site_domain_form_template">
        {{ site_domain_form_template.as_table }}
    </script>

    <script type="text/template" id="module_form_template">
        {{ module_form_template.as_table }}
    </script>

    <script type="text/template" id="site_config_form_template">
        {{ site_config_form_template.as_table }}
    </script>
    <script type="text/javascript">
        $(function() {
            $( ".datepicker" ).datepicker();
        });
        $("form").live('submit', function(evt){
            var submit_to = $(this).attr("action"),
                $this = $(this),
                $submit_button = $(this.Submit),
                data = {};

            function get_form_object($form) {
                var data = {};
                $form.serializeArray().map(function(e){
                    if (e.hasOwnProperty('name') && e.hasOwnProperty('value')) {
                        data[e.name] = e.value;
                    }
                });
                return data;
            }

            data = get_form_object($this);

            $submit_button.button("loading");

            evt.preventDefault();

            handlers = {
                'site_config': function(response) {
                    if(response.hasOwnProperty('action') && response.hasOwnProperty('status') && response.status === 'ok') {
                        if(response.action === 'delete') {
                            $("#site-configs a:first").click();
                            $("#site-configs").find('li[data-form-id="'+ response.id +'"]').remove();
                            $("#site-configs").tab();
                            $("#site-config-"+response.id).remove();
                        }
                        if(response.action === 'add') {
                            $("#site-configs").append(
                                $("<li/>").attr('data-form-id', response.id)
                                          .html(
                                            $("<a/>").attr("href", "#site-config-" + response.id)
                                                     .attr("data-toggle", "tab")
                                                     .html(response.name)
                                )
                            );
                            $("#site-configs").tab();
                            $("#site-config-forms").append(
                                $("<div/>").addClass('tab-pane')
                                           .attr('id', 'site-config-' + response.id)
                                           .attr('data-form-id', response.id)
                                           .html(
                                                $("<h2/>").html(response.name))
                                           .append(response.item)
                            );
                            $("#add-site-config table").html($("#site_config_form_template").html())
                            $("#status-site-domains").load("/backend #status-site-domains")
                            $("#monitors").load("/backend #monitors")
                        }
                    }
                },
                'site_domain': function (response) {
                    if(response.hasOwnProperty('action') && response.hasOwnProperty('status') &&
                            response.status === 'ok') {
                        if (response.action === 'delete') {
                            $("#site-domains a:first").click();
                            $("#site-domains").find('li[data-form-id="'+ response.id +'"]').remove();
                            $("#site-domains").tab();
                            $("#site-domain-"+response.id).remove();
                        }
                        if(response.action === 'add') {
                            $("#site-domains").append(
                                    $("<li/>").attr('data-form-id', response.id)
                                            .html(
                                            $("<a/>").attr("href", "#site-domain-" + response.id)
                                                    .attr("data-toggle", "tab")
                                                    .html(response.name)
                                            )
                            );
                            $("#site-domains").tab();
                            $("#site-domain-forms").append(
                                    $("<div/>").addClass('tab-pane')
                                            .attr('id', 'site-domain-' + response.id)
                                            .attr('data-form-id', response.id)
                                            .html(
                                            $("<h2/>").html(response.name))
                                            .append(response.item)
                            );
                            $("#add-site-domain table").html($("#site_domain_form_template").html())
                        }
                    }
                },
                'module': function(response) {
                    if(response.hasOwnProperty('action') && response.hasOwnProperty('status') &&
                            response.status === 'ok') {
                        if (response.action === 'delete') {
                            $("#modules a:first").click();
                            $("#modules").find('li[data-form-id="'+ response.id +'"]').remove();
                            $("#modules").tab();
                            $("#module-"+response.id).remove();
                        }
                        if(response.action === 'add') {
                            $("#modules").append(
                                    $("<li/>").attr('data-form-id', response.id)
                                            .html(
                                            $("<a/>").attr("href", "#module-" + response.id)
                                                    .attr("data-toggle", "tab")
                                                    .html(response.name)
                                    )
                            );
                            $("#modules").tab();
                            $("#module-forms").append(
                                    $("<div/>").addClass('tab-pane')
                                            .attr('id', 'module-' + response.id)
                                            .attr('data-form-id', response.id)
                                            .html(
                                            $("<h2/>").html(response.name))
                                            .append(response.item)
                            );
                            $("#add-module table").html($("#module_form_template").html())
                        }
                    }
                }
            };

            //clear errors before submit
            $this.find('.input-error').removeClass('input-error');
            $this.find('.error').remove();

            $.post(submit_to,data,
                function(response){
                    $submit_button.button("complete");

                    setTimeout(function() {
                        $submit_button.button("reset");
                    }, 2000);

                    if (response.hasOwnProperty('target') &&
                        typeof handlers[response.target] === 'function') {
                        handlers[response.target](response);
                    }
                    if (response.hasOwnProperty('error')) {
                        for (var key in response.error) {
                            if (response.error.hasOwnProperty(key)) {
                                var $input = $this.find('*[name="'+key +'"]');
                                $input.addClass('input-error').after("<p class='error'>"+ response.error[key] +"</p>");
                            }
                        }
                    }

                    $(".datepicker").datepicker();
                })
        });
        $(document).ready(function(){
           // $("#navbar").scrollspy();
           // $(".btn").button();

            $("#site-configs").tab();
            $('#site-configs a').click(function (e) {
                e.preventDefault();
                $(this).tab('show');
            });
            $("#modules").tab();
            $('#modules a').click(function (e) {
                e.preventDefault();
                $(this).tab('show');
            });

            $("#site-domains").tab();
            $('#site-domains a').click(function (e) {
                e.preventDefault();
                $(this).tab('show');
            });

            $(".module-delete").live("click", function(e){
                $('input[name="module_action"]').val('delete')
            });

            $(".module-update").live("click", function(e){
                $('input[name="module_action"]').val('update')
            });

            $(".site-config-delete").live("click", function(e){
                $('input[name="site_config_action"]').val('delete')
            });

            $(".site-config-update").live("click", function(e){
                $('input[name="site_config_action"]').val('update')
            });

            $(".site-domain-delete").live("click", function(e){
                $('input[name="site_domain_action"]').val('delete')
            });

            $(".site-domain-update").live("click", function(e){
                $('input[name="site_domain_action"]').val('update')
            });
        });
    </script>
</body>
</html>